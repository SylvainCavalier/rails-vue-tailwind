# Devise Integration Guide

This boilerplate is pre-configured to be compatible with Devise. Here are the steps to install it without conflicts.

## Installing Devise

### 1. Install Devise

```bash
# Gems are already in the Gemfile
bundle install

# Generate Devise configuration
rails generate devise:install
```

### 2. Configure Devise with SecureHeaders

After installation, in your Devise controllers, add:

```ruby
# app/controllers/users/sessions_controller.rb (if you customize it)
class Users::SessionsController < Devise::SessionsController
  before_action :use_secure_headers_override

  private

  def use_secure_headers_override
    use_secure_headers_override(:devise_forms)
  end
end
```

### 3. Create the User model

```bash
# Generate User model
rails generate devise User

# Migrate
rails db:migrate
```

### 4. Uncomment in ApplicationController

In `app/controllers/application_controller.rb`, uncomment:

```ruby
before_action :authenticate_user!
before_action :configure_permitted_parameters, if: :devise_controller?
```

### 5. Configure routes (optional)

In `config/routes.rb`, you can customize:

```ruby
devise_for :users, controllers: {
  sessions: 'users/sessions',
  registrations: 'users/registrations',
  passwords: 'users/passwords'
}
```

## Ready-Made Configurations

### SecureHeaders
- ✅ CSP configured to allow Devise forms
- ✅ Override configuration available (`:devise_forms`)
- ✅ Support for OAuth redirections

### Rack::Attack  
- ✅ Rate limiting on login attempts
- ✅ Rate limiting on password reset attempts
- ✅ Rate limiting on account creation
- ✅ Compatible with default Devise routes

### InvisibleCaptcha
- ✅ Anti-spam protection on forms
- ✅ Compatible with Devise forms

### Good Job
- ✅ Ready for asynchronous Devise emails
- ✅ Configuration for cleanup tasks

## Customizing Views

```bash
# Generate Devise views for customization
rails generate devise:views

# Or for a specific scope
rails generate devise:views users
```

## Mailer Configuration

The mailer is already configured with `letter_opener` in development in `config/environments/development.rb`.

For production, add to `config/environments/production.rb`:

```ruby
config.action_mailer.default_url_options = { host: 'your-domain.com', protocol: 'https' }
config.action_mailer.delivery_method = :smtp
# Add your SMTP configuration
```

## Recommended Environment Variables

Add to your `.env`:

```env
# Devise
DEVISE_SECRET_KEY=your_devise_secret_key

# Mailer (production)
SMTP_HOST=smtp.your-provider.com
SMTP_PORT=587
SMTP_USERNAME=your-username
SMTP_PASSWORD=your-password
```

## Testing with Devise

The boilerplate includes `factory_bot_rails`. Create your factories:

```ruby
# spec/factories/users.rb
FactoryBot.define do
  factory :user do
    email { Faker::Internet.email }
    password { "password123" }
    password_confirmation { "password123" }
  end
end
```

## OAuth (optional)

If you add OAuth (Google, Facebook, etc.), the CSP is already configured to allow external HTTPS redirections.

## Debugging

If you encounter issues:

1. **CSP violations**: Check browser console for CSP errors
2. **Rate limiting**: Check logs for Rack::Attack messages  
3. **Mailer errors**: Verify that `letter_opener` works in dev

## Loading Order

Initializers load automatically in alphabetical order:
- `devise.rb` (generated by Devise)
- `rack_attack.rb` (rate limiting protection)
- `secure_headers.rb` (security headers)

No dependency conflicts thanks to compatible configuration.
